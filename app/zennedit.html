<html>
<head>
    <title>Zennedit</title>
    <script src="https://unpkg.com/react/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
        }
        ::-webkit-scrollbar {
            display: none;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        code {
        background-color: #2c2c2c;
        color: #f8f8f2;
        padding: 2px 4px;
        border-radius: 4px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 90%;
        }
        pre {
            background-color: #2c2c2c;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 90%;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [subreddits, setSubreddits] = useState(() => {
                const savedSubreddits = localStorage.getItem('subreddits');
                return savedSubreddits ? JSON.parse(savedSubreddits) : [{ name: 'r/technology' }];
            });
            const [selectedSubreddit, setSelectedSubreddit] = useState(() => {
                const savedSubreddit = localStorage.getItem('selectedSubreddit');
                return savedSubreddit ? savedSubreddit : 'r/technology';
            });
            const [posts, setPosts] = useState([]);
            const [selectedPost, setSelectedPost] = useState(null);
            const [comments, setComments] = useState([]);
            const [sort, setSort] = useState('hot');
            const [newSubreddit, setNewSubreddit] = useState('');
            const [showPopup, setShowPopup] = useState(false);
            const [subredditToDelete, setSubredditToDelete] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const sidebarRef = useRef(null);

            const fetchPosts = () => {
                fetch(`https://www.reddit.com/${selectedSubreddit}/${sort}.json`)
                    .then(response => response.json())
                    .then(data => {
                        const fetchedPosts = data.data.children.map(child => ({
                            id: child.data.id,
                            title: child.data.title,
                            author: child.data.author,
                            content: child.data.selftext,
                            url: child.data.url,
                            subreddit: child.data.subreddit_name_prefixed,
                            created_utc: child.data.created_utc,
                            gallery_data: child.data.gallery_data,
                            media_metadata: child.data.media_metadata
                        }));
                        setPosts(fetchedPosts);
                    });
            };

            useEffect(() => {
                fetchPosts();
            }, [selectedSubreddit, sort]);

            useEffect(() => {
                localStorage.setItem('subreddits', JSON.stringify(subreddits));
            }, [subreddits]);

            useEffect(() => {
                localStorage.setItem('selectedSubreddit', selectedSubreddit);
            }, [selectedSubreddit]);

            const viewPost = (postId) => {
                const post = posts.find(p => p.id === postId);
                setSelectedPost(post);
                fetch(`https://www.reddit.com/${selectedSubreddit}/comments/${postId}.json`)
                    .then(response => response.json())
                    .then(data => {
                        const fetchedComments = data[1].data.children.map(child => {
                            const commentData = {
                                author: child.data.author,
                                body: child.data.body,
                                media_metadata: child.data.media_metadata
                            };
                            if (commentData.body.includes("https://preview.redd.it")) {
                                const mediaId = Object.keys(commentData.media_metadata)[0];
                                const media = commentData.media_metadata[mediaId];
                                commentData.imageUrl = media.s.u.replace(/&amp;/g, '&');
                                commentData.body = commentData.body.replace(/https:\/\/preview\.redd\.it\S+/g, '');
                            }
                            return commentData;
                        });
                        setComments(fetchedComments);
                    });
            };

            const addSubreddit = () => {
                if (newSubreddit && !subreddits.some(sub => sub.name === newSubreddit)) {
                    setSubreddits([...subreddits, { name: newSubreddit }]);
                    setNewSubreddit('');
                }
            };

            const handleRightClick = (e, subreddit) => {
                e.preventDefault();
                setSubredditToDelete(subreddit);
                setShowPopup(true);
            };

            const confirmDelete = () => {
                setSubreddits(subreddits.filter(sub => sub.name !== subredditToDelete));
                setShowPopup(false);
                setSubredditToDelete(null);
            };

            const cancelDelete = () => {
                setShowPopup(false);
                setSubredditToDelete(null);
            };

            const handleClickOutside = (event) => {
                if (sidebarRef.current && !sidebarRef.current.contains(event.target)) {
                    setSidebarOpen(false);
                }
            };

            useEffect(() => {
                if (sidebarOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                } else {
                    document.removeEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [sidebarOpen]);

            const formatDate = (timestamp) => {
                const date = new Date(timestamp * 1000);
                return date.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            const handleTouchStart = (e) => {
                const touch = e.touches[0];
                setTouchStartX(touch.clientX);
            };

            const handleTouchMove = (e) => {
                if (!touchStartX) return;
                const touch = e.touches[0];
                const touchEndX = touch.clientX;
                const touchDiff = touchEndX - touchStartX;

                if (touchDiff > 50) {
                    setSelectedPost(null);
                }
            };

            const [touchStartX, setTouchStartX] = useState(null);

            const renderGallery = (post) => {
                if (!post.gallery_data || !post.media_metadata) return null;

                const items = post.gallery_data.items.map(item => {
                    const media = post.media_metadata[item.media_id];
                    const src = media.s.u.replace(/&amp;/g, '&');
                    return <img key={item.media_id} src={src} alt="Gallery item" className="w-full h-auto rounded mt-2 max-w-full" />;
                });

                return <div className="gallery">{items}</div>;
            };

            const renderFormattedText = (text) => {
                const sanitizedText = text.replace(/\\/g, '');
                const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g;
                let formattedText = sanitizedText.replace(linkRegex, (match, p1, p2) => {
                    return `<a href="${p2}" class="text-blue-500 underline">${p1}</a>`;
                });
              
                const inlineRegex = [
                    { regex: /~~(.*?)~~/g, tag: 'del' },
                    { regex: /\^(\S+)/g, tag: 'sup' },
                    { regex: /`(.*?)`/g, tag: 'code' }
                ];
            
                inlineRegex.forEach(({ regex, tag }) => {
                    formattedText = formattedText.replace(regex, (match, p1) => {
                        return `<${tag}>${p1}</${tag}>`;
                    });
                });
            
                const markdownRegex = [
                    { regex: /(\*\*\*|___)(.*?)\1/g, tag: 'strong', className: 'italic' },
                    { regex: /(\*\*|__)(.*?)\1/g, tag: 'strong' },
                    { regex: /(\*|_)(.*?)\1/g, tag: 'em' }
                ];
            
                markdownRegex.forEach(({ regex, tag, className }) => {
                    formattedText = formattedText.replace(regex, (match, p1, p2) => {
                        return `<${tag} class="${className || ''}">${p2}</${tag}>`;
                    });
                });

                const codeBlockRegex = /((?:^|\n)(?: {4}.*\n)+)/g;
                formattedText = formattedText.replace(codeBlockRegex, (match, p1) => {
                    const codeContent = p1.replace(/^ {4}/gm, '');
                    return `<pre>${codeContent}</pre>`;
                });
                formattedText = formattedText.replace(/\n/g, '<br/>');
                return <span dangerouslySetInnerHTML={{ __html: formattedText }} />;
            };

            return (
                <div className="flex h-screen">
                    <div ref={sidebarRef} className={`fixed inset-y-0 left-0 transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out w-64 bg-gray-900 p-4 z-50`}>
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center">
                                <i className="fab fa-reddit text-white text-2xl"></i>
                                <span className="ml-2 text-white text-xl">Zennedit</span>
                            </div>
                            <button className="text-white" onClick={() => setSidebarOpen(false)}>
                                <i className="fas fa-arrow-left"></i>
                            </button>
                        </div>
                        <div className="mb-4">
                            <h2 className="text-gray-400">Subreddits</h2>
                            {subreddits.map((subreddit, index) => (
                                <div 
                                    className="flex items-center mt-2 cursor-pointer" 
                                    key={index} 
                                    onClick={() => setSelectedSubreddit(subreddit.name)}
                                    onContextMenu={(e) => handleRightClick(e, subreddit.name)}
                                >
                                    <div className="ml-2 text-white">{subreddit.name}</div>
                                </div>
                            ))}
                        </div>
                        <div className="mt-4">
                            <input
                                type="text"
                                placeholder="Add subreddit"
                                className="w-full p-2 bg-gray-800 text-white rounded"
                                value={newSubreddit}
                                onChange={(e) => setNewSubreddit(e.target.value)}
                            />
                            <button className="mt-2 w-full p-2 bg-gray-700 text-white rounded" onClick={addSubreddit}>Add Subreddit</button>
                        </div>
                    </div>
                    <div className="flex-1 bg-gray-800 p-4 flex flex-col">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center">
                                <button className="text-white mr-4" onClick={() => setSidebarOpen(!sidebarOpen)}>
                                    <i className="fas fa-bars"></i>
                                </button>
                                <div className="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-white">
                                    <i className="fab fa-reddit text-2xl"></i>
                                </div>
                                <div className="ml-2">
                                    <div className="text-white">{selectedSubreddit}</div>
                                    <div className="text-gray-400 text-sm">Posts</div>
                                </div>
                            </div>
                            <div className="flex items-center">
                                <select className="p-2 bg-gray-700 text-white rounded" value={sort} onChange={(e) => setSort(e.target.value)}>
                                    <option value="hot">Hot</option>
                                    <option value="new">New</option>
                                    <option value="top">Top</option>
                                    <option value="rising">Rising</option>
                                </select>
                                <button className="text-white ml-4" onClick={fetchPosts}>
                                    <i className="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove}>
                            {selectedPost ? (
                                <div>
                                    <div className="text-white bg-gray-700 p-2 rounded mt-1">{selectedPost.title}</div>
                                    <div className="text-gray-400 text-sm mt-1 flex justify-between">
                                        <span>by {selectedPost.author}</span>
                                        <span>{formatDate(selectedPost.created_utc)}</span>
                                    </div>
                                    <div className="text-white bg-gray-700 p-2 rounded mt-1">{renderFormattedText(selectedPost.content)}</div>
                                    {selectedPost.url && selectedPost.url.includes("https://www.reddit.com/gallery/") ? (
                                        renderGallery(selectedPost)
                                    ) : (
                                        selectedPost.url && !selectedPost.url.includes("/comments/") && <img src={selectedPost.url} alt="Post content" className="mt-2 rounded max-w-full" />
                                    )}
                                    <div className="text-gray-400 text-sm mt-1">Comments</div>
                                    {comments.map((comment, index) => (
                                        <div className="text-white bg-gray-700 p-2 rounded mt-1" key={index}>
                                            <div className="text-gray-400 text-sm">by {comment.author}</div>
                                            <div>{renderFormattedText(comment.body)}</div>
                                            {comment.imageUrl && <img src={comment.imageUrl} alt="Comment embedded content" className="mt-2 rounded" height="35%" width="35%" />}
                                        </div>
                                    ))}
                                    <button className="mt-4 p-2 bg-gray-700 text-white rounded" onClick={() => setSelectedPost(null)}>Back to Posts</button>
                                </div>
                            ) : (
                                posts.map((post, index) => (
                                    <div className="mb-4" key={index}>
                                        <div className="text-white bg-gray-700 p-2 rounded mt-1 flex justify-between items-center">
                                            <span>{post.title}</span>
                                            <button className="ml-4 p-2 bg-gray-700 text-white rounded" onClick={() => viewPost(post.id)}>View Post</button>
                                        </div>
                                        <div className="text-gray-400 text-sm mt-1 flex justify-between">
                                            <span>by {post.author}</span>
                                            <span>{formatDate(post.created_utc)}</span>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                    {showPopup && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                            <div className="bg-gray-800 p-4 rounded">
                                <div className="text-white mb-4">Do you want to delete {subredditToDelete}?</div>
                                <div className="flex justify-end">
                                    <button className="p-2 bg-gray-700 text-white rounded mr-2" onClick={confirmDelete}>Yes</button>
                                    <button className="p-2 bg-gray-700 text-white rounded" onClick={cancelDelete}>No</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
